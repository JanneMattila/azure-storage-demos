# BlockBlobs

Test parameters:
- Azure Storage: 
  - Account kind: StorageV2 (general purpose v2)
  - Performance: Standard (HDD)
  - Replication: Locally-redundant storage (LRS)
- Virtual Machine:
  - SKU: [Standard_D2ds_v4](https://learn.microsoft.com/en-us/azure/virtual-machines/ddv4-ddsv4-series#ddsv4-series)
- Upload code [Python upload code](https://github.com/JanneMattila/python-examples/tree/main/azure-storage)
  - 256 MB file generated using: `head -c 256m </dev/urandom > demo.bin`
  - Single large file is generated by uploading this file as [BlockBlob](https://learn.microsoft.com/en-us/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs#about-block-blobs)
  - 4000 blocks will be generated using [Put Block](https://learn.microsoft.com/en-us/rest/api/storageservices/put-block?tabs=azure-ad) API
  - After uploading blocks, file is committed using [Put Block List](https://learn.microsoft.com/en-us/rest/api/storageservices/put-block-list?tabs=azure-ad) API call

Overview of the process:

```mermaid
sequenceDiagram
    participant Upload app
    participant Azure Blob
    Note left of Upload app: Read file in 256 MB chunks
    Upload app->>+Azure Blob: Put Block
    Upload app->>+Azure Blob: Put Block
    Upload app->>+Azure Blob: Put Block
    Upload app->>+Azure Blob: <repeat for all blocks>
    Note left of Upload app: Commit and finalize upload
    Upload app->>+Azure Blob: Put Block List
```

Metrics view while uploading blocks using [Put Block](https://learn.microsoft.com/en-us/rest/api/storageservices/put-block?tabs=azure-ad) API:

![blob metrics while uploading BlockBlob](https://user-images.githubusercontent.com/2357647/230024864-d251815d-737c-4874-8ff3-39652be0380d.png)

Metrics view after uploading has finished and final [Put Block List](https://learn.microsoft.com/en-us/rest/api/storageservices/put-block-list?tabs=azure-ad) API call is made:

![blob metrics after file upload has finished](https://user-images.githubusercontent.com/2357647/230033211-7041435c-bd8c-477a-9e4f-fdf31bbe7581.png)

Entire upload duration API calls:

![upload duration api calls](https://user-images.githubusercontent.com/2357647/230034278-616c7a15-067c-4f64-bafd-a11c43d6140b.png)

Uploaded file in container:

![file in container](https://user-images.githubusercontent.com/2357647/230034841-bbca006a-d25b-4a05-8888-5cadb4b78831.png)
